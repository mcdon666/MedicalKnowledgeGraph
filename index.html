<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŒ»å­¦å›¾è°±å¯è§†åŒ–</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <script src="https://unpkg.com/cytoscape@3.20.0/dist/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.0.0/dist/echarts-wordcloud.min.js"></script>

  <style>
    /* body {
      font-family: sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    } */

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #121212;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* é¡¶éƒ¨å¯¼èˆªæ  */
    #navbar {
      background-color: #1e1e1e;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #ccc;
    }

    #navbar input {
      padding: 6px;
      width: 250px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
    }

    /* ä¸»ä½“ä¸‰æ å¸ƒå±€ */
    #main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* å·¦ä¾§è¯äº‘åŒºåŸŸ */
    #left-panel {
      width: 25%;
      background-color: #1a1a1a;
      border-right: 1px solid #444;
      padding: 10px;
    }

    /* ä¸­é—´å­å›¾æŒ‰é’® + å›¾åŒºåŸŸ */
    #center-panel {
      flex: 1;
      background-color: #181818;
      padding: 10px;
    }

    /* .graph-box {
      width: 100%;
      height: 500px;
      border: 1px solid #555;
      margin-top: 10px;
    } */

    .graph-box {
      width: 100%;
      height: 500px;
      max-width: 100%;
      overflow: hidden;
      /* border: 1px solid #555; */
      margin-top: 10px;
      box-sizing: border-box;
    }

    .subgraph-button-group {
      display: flex;
      justify-content: center;   /* æ°´å¹³å±…ä¸­å¯¹é½ */
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;           /* è‡ªåŠ¨æ¢è¡Œé€‚é…çª„å± */
    }


    .subgraph-button {
      background-color: #444;     /* æ·±ç°èƒŒæ™¯ */
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 14px;
    }

    .subgraph-button:hover {
      background-color: #4caf50;  /* é¼ æ ‡æ‚¬åœå˜ç»¿è‰² */
    }

    /* å³ä¾§èŠå¤© + ç–¾ç—…é¢„æµ‹ */
    #right-panel {
      width: 30%;
      background-color: #1a1a1a;
      border-left: 1px solid #444;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }

    #chat-log {
      flex: 1;
      border: 1px solid #555;
      padding: 8px;
      margin-bottom: 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      background: #222;
      color: #fff;
      font-size: 14px;
    }

    #chat-input-area {
      display: flex;
    }

    #chat-input {
      flex: 1;
      padding: 5px;
      font-size: 14px;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
    }

    #chat-send {
      padding: 5px 10px;
      margin-left: 5px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #chat-send:hover {
      background-color: #1976D2;
    }

    button {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px 5px 0 0;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #1976D2;
    }



  </style>
  
  
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <div id="navbar">
    <div>
      <input id="disease-input" type="text" placeholder="è¯·è¾“å…¥ç–¾ç—…åç§°" />
      <button onclick="loadData()">æœç´¢</button>
    </div>
    <div style="font-size: 13px; color: #aaa;">
      æœ¬ç½‘ç«™ä»…ä¾›å‚è€ƒï¼Œå¦‚æœ‰ä¸é€‚è¯·åŠæ—¶å°±åŒ»
    </div>
  </div>

  <!-- ä¸»ä½“ä¸‰æ  -->
  <div id="main-container">
    
    <!-- å·¦ä¾§è¯äº‘åŒº -->
    <div id="left-panel">
      <div id="wordcloud" style="height: 100%;"></div>
    </div>

    <!-- ä¸­é—´å›¾è°±åŒº -->
    <div id="center-panel">
      <div class="graph-box" id="graph"></div>
      <div class="subgraph-button-group">
        <button class="subgraph-button" onclick="loadSubgraph('å¹¶å‘ç—‡')">å…³è”ç–¾ç—…</button>
        <button class="subgraph-button" onclick="loadSubgraph('ç—‡çŠ¶')">æ½œåœ¨ç—‡çŠ¶</button>
        <button class="subgraph-button" onclick="loadSubgraph('ç§‘å®¤')">æ‰€å±ç§‘å®¤</button>
        <button class="subgraph-button" onclick="loadSubgraph('é¥®é£Ÿ')">é¥®é£Ÿå»ºè®®</button>
        <button class="subgraph-button" onclick="loadSubgraph('è¯ç‰©')">æ¨èç”¨è¯</button>
        <button class="subgraph-button" onclick="loadSubgraph('æ£€æŸ¥')">æ¨èæ£€æŸ¥</button>
      </div>
      
    </div>

    <!-- å³ä¾§èŠå¤©ä¸é¢„æµ‹ -->
    <div id="right-panel">
      <div id="chat-log"></div>
      <div id="chat-input-area">
        <input id="chat-input" type="text" placeholder="è¯·è¾“å…¥é—®é¢˜..." />
        <button id="chat-send">å‘é€</button>
      </div>

      <!-- ç–¾ç—…é¢„æµ‹ç»“æœåŒºåŸŸï¼ˆçŸ©å½¢æ ‘å›¾ï¼‰ -->
      <div id="predict-input-area">
        <input id="symptom-input" type="text" placeholder="è¯·è¾“å…¥ç—‡çŠ¶ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰" style="width: 80%;" />
        <button id="predict-btn">é¢„æµ‹ç–¾ç—…</button>
      </div>
      <div id="predict-box" style="height: 300px; margin-top: 10px;"></div>
    </div>

  </div>
  
  
  <script>
    function loadData() {
      const disease = document.getElementById('disease-input').value;
      loadWordCloud(disease);
    }
  
    function loadWordCloud(disease) {
      fetch(`http://127.0.0.1:5000/api/wordcloud?name=${encodeURIComponent(disease)}`)
        .then(res => res.json())
        .then(data => {
          const wordChart = echarts.init(document.getElementById('wordcloud'));
          wordChart.setOption({
            tooltip: {},
            series: [{
              type: 'wordCloud',
              shape: 'circle',
              gridSize: 8,
              sizeRange: [12, 40],
              rotationRange: [0, 0],
              textStyle: {
                color: () => {
                  return 'rgb(' + [
                    Math.round(Math.random() * 200),
                    Math.round(Math.random() * 200),
                    Math.round(Math.random() * 200)
                  ].join(',') + ')';
                }
              },
              data: data
            }]
          });
        });
    }
  
    function loadSubgraph(type) {
      // document.getElementById('graph').innerHTML = "åŠ è½½ä¸­...";
      const disease = document.getElementById('disease-input').value;
      fetch(`http://127.0.0.1:5000/api/graph?name=${disease}&type=${type}`)
        .then(res => res.json())
        .then(data => {
          if (window.cy) window.cy.destroy();
          window.cy = cytoscape({
            container: document.getElementById('graph'),
            elements: [...data.nodes, ...data.edges],
            style: [
              {
                selector: 'node',
                style: {
                  'label': 'data(label)',
                  'font-size': 10,  // ğŸ‘ˆ æ§åˆ¶å­—ä½“å¤§å°ï¼ˆæ ¹æ®éœ€è¦å¯è°ƒå°ï¼‰
                  'color': '#ffffff',  // ğŸ‘ˆ å­—ä½“é¢œè‰²è®¾ä¸ºç™½è‰²ï¼ˆé€‚åˆé»‘è‰²èƒŒæ™¯ï¼‰
                  'text-outline-width': 2,  // ğŸ‘ˆ æ–‡å­—æè¾¹å®½åº¦
                  'text-outline-color': '#000000',  // ğŸ‘ˆ é»‘è‰²æè¾¹å¢å¼ºå¯è¯»æ€§
                  'background-color': ele => {
                    const type = ele.data('type');
                    return {
                      'Disease': '#ff9999',
                      'Drug': '#99ccff',
                      'Symptom': '#ccffcc',
                      'Food': '#ffffcc',
                      'Check': '#d9b3ff'
                    }[type] || '#ccc';
                  }
                }
              },
              {
                selector: 'edge',
                style: {
                  // 'label': 'data(label)',
                  'curve-style': 'bezier',
                  'target-arrow-shape': 'triangle',
                  'line-color': ele => {
                    const type = ele.data('label');
                    return type === 'no_eat' ? '#ff4444' :  // çº¢è‰²ï¼šå¿Œåƒ
                          type === 'recommand_eat' || type === 'do_eat' ? '#44bb44' : '#999';  // ç»¿è‰²ï¼šæ¨è/å®œåƒ
                  },
                  'target-arrow-color': ele => {
                    const type = ele.data('label');
                    return type === 'no_eat' ? '#ff4444' :
                          type === 'recommand_eat' || type === 'do_eat' ? '#44bb44' : '#999';
                  }
                }
              }
            ],
            layout: { name: 'cose' }
          });
        });
    }

    function predictDiseaseBySymptoms(symptoms) {
      fetch("http://127.0.0.1:5000/api/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ symptoms: symptoms })
      })
        .then(res => res.json())
        .then(data => {
          const chart = echarts.init(document.getElementById("predict-box"));
          chart.setOption({
            tooltip: {
              formatter: info => `${info.name}ï¼š${info.value}`
            },
            series: [{
              type: 'treemap',
              roam: false,
              nodeClick: false,
              label: {
                show: true,
                formatter: '{b}'
              },
              data: data.map(d => ({ name: d.name, value: d.probability }))
            }]
          });
        })
        .catch(err => {
          document.getElementById("predict-box").innerHTML = "é¢„æµ‹å¤±è´¥ï¼šè¯·æ£€æŸ¥æœåŠ¡ç«¯æ˜¯å¦å·²å¼€å¯ã€‚";
        });
    }

    document.getElementById('predict-btn').addEventListener('click', () => {
      const input = document.getElementById('symptom-input').value.trim();
      if (!input) return;
      const symptoms = input.split("ï¼Œ").join(",").split(",").map(s => s.trim()).filter(s => s);
      predictDiseaseBySymptoms(symptoms);
    });

  
    document.getElementById('chat-send').addEventListener('click', () => {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;
  
      const chatLog = document.getElementById('chat-log');
      chatLog.innerHTML += `<div><strong>ğŸ§‘ ä½ ï¼š</strong>${message}</div>`;
  
      fetch('http://127.0.0.1:5000/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: message })
      })
        .then(res => res.json())
        .then(data => {
          chatLog.innerHTML += `ğŸ¤– æ™ºèƒ½åŠ©æ‰‹ï¼š${data.answer}<br/><br/>`;
          chatLog.scrollTop = chatLog.scrollHeight;
        });
  
      input.value = '';
    });
  
    document.getElementById('chat-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') document.getElementById('chat-send').click();
    });
  
    // åˆå§‹åŠ è½½
    window.onload = () => {
      document.getElementById('disease-input').value = ''; // åˆå§‹ç–¾ç—…
      loadData();
    };
  </script>
  

</body>

</html>
